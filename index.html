<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Graph Editor</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.24.0/cytoscape.min.js"></script>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    #cy {
      background-color: black;
      width: 100%;
      height: 90vh;
      border: 1px solid #ccc;
    }
    #controls {
  padding: 10px;
  background: #292421;
  position: fixed; /* Keep controls visible on smaller screens */
  bottom: 0;
  left: 0;
  right: 0;
  display: flex;
  flex-wrap: wrap; /* Adjust for small screens */
  justify-content: space-evenly;
  z-index: 10; /* Ensure it appears above the canvas */
}

    #controls select, #controls button, #controls input {
      margin: 5px;
    }
  </style>
</head>
<body>
  <div id="cy"></div>
  <div id="info-panel"></div>
  <div id="controls">
    <select id="nodeClass" multiple>
  <option value="N010">Type A</option>
  <option value="N020">Type B</option>
  <option value="N030">Type C</option>
</select>
    <label for="edgeClass"> :</label>
    <select id="edgeClass">
      <option value="Implies">Implies</option>
      <option value="Contradicts">Contradicts</option>
      <option value="Supports">Supports</option>
      <option value="Undermines">Undermines</option><option value="Money">Money</option><option value="Debt">Debt</option>
    </select>
   

    <button id="addEdge">Add Edge</button>
    <button id="deleteEdge">Delete Edge</button>
    <button id="save">Save JSON</button>

    <input type="range" id="confidenceSlider" min="0" max="1" step="0.01" value="0">
    <span id="confidenceValue">0.00</span>
    <button id="toggleLabels">Labels</button>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const graphData = {
        elements: {
          nodes: [
{ data: { id: "010N020", label: "I need to be able to have AI act on my work programs", confidence: .9
}, position:{"x":543.83551115436057,"y":630.41260569424412}, classes:"N020"}, { data: { id: "011N020", label: "I can’t really scan text well enough to make transferring text back and forth reliable.", confidence: .9
}, position:{"x":511.56250162449584,"y":682.62474086290763}, classes:"N020"}, { data: { id: "012N020", label: "Im not sure the policy on github or AI as of today.", confidence: .99
}, position:{"x":600.95730486581101,"y":-20.359483968297397}, classes:"N020"}, { data: { id: "013N020", label: "having my notes and files separate will make documentation harder", confidence: 0.8
}, position:{"x":589.64201148558891,"y":209.47018354526949}, classes:"N020"}, { data: { id: "014N020", label: "I don’t need anyone else to see my second brain", confidence: 0.7
}, position:{"x":496.32520361709061,"y":744.76794225525794}, classes:"N020"}, { data: { id: "015N020", label: "AI is my best shot at creating documentation", confidence: 0.95
}, position:{"x":627.03726739996171,"y":-189.69151159997446}, classes:"N020"}, { data: { id: "010N010", label: "Use local Vault inside working copy app", confidence: 0.9
}, position:{"x":-198.26690390751185,"y":58.748201355636226}, classes:"N010"}, { data: { id: "012N010", label: "Use blank template for initialization", confidence: 0.9
}, position:{"x":591.75074975457846,"y":141.73783115823943}, classes:"N010"}, { data: { id: "015N010", label: "automate push after initial json", confidence: 0.5
}, position:{"x":426.38836850973655,"y":-429.30118755788453}, classes:"N010"}, { data: { id: "018N010", label: "Use Action button to access list of github pages", confidence: 0.9
}, position:{"x":-95.16389207859369,"y":401.77747446724328}, classes:"N010"}, { data: { id: "020N010", label: "Explore ways to automate finding the download", confidence: 0.9
}, position:{"x":110.65194463939959,"y":-95.015078306043009}, classes:"N010"}, { data: { id: "021N010", label: "2 shortcuts, 1 for updating graph, 1 for viewing it", confidence: 0.8
}, position:{"x":482.90352848410947,"y":453.00294587377488}, classes:"N010"}, { data: { id: "022N010", label: "Select entire folders?", confidence: 0.5
}, position:{"x":134.20294880765829,"y":47.257442700418181}, classes:"N010"}, { data: { id: "023N010", label: "1 note per repo", confidence: 0.5
}, position:{"x":250.25775312457881,"y":187.94637374583206}, classes:"N010"}, { data: { id: "024N010", label: "name the download after the repo", confidence: 0.9
}, position:{"x":385.45138620160407,"y":-79.833953721055408}, classes:"N010"}, { data: { id: "100N010", label: "create GitHub repo with random name and robots.txt", confidence: 0.9
}, position:{"x":497.14341698238701,"y":387.08628479855713}, classes:"N010"}, { data: { id: "110N010", label: "clone repo into working copy", confidence: 0.9
}, position:{"x":515.3102246522169,"y":327.99983042719151}, classes:"N010"}, { data: { id: "115N010", label: "initialize vault within working copy repo", confidence: 0.9
}, position:{"x":486.91818093588921,"y":847.76597565683164}, classes:"N010"}, { data: { id: "116N010", label: "put json in repo to map repo name to vault name?", confidence: 0.5
}, position:{"x":521.2349922633623,"y":529.30552137011398}, classes:"N010"}, { data: { id: "117N010", label: "update by taking all md from repo and most recent download with matching name", confidence: 0.9
}, position:{"x":618.4348145964484,"y":281.14708665367681}, classes:"N010"} ],
         edges: [{locked:false,position:{x:0,y:0},grabbable:true,data:{id:"8d84256c-846c-4ae4-9000-2473490e3338",target:"010N010",source:"018N010"},removed:false,selectable:true,selected:false,pannable:true,classes:"Supports",group:"edges"}, {locked:false,position:{x:0,y:0},grabbable:true,data:{id:"55b63e09-bf53-4edb-ae83-15314982e3b6",source:"020N010",description:"Test description what happens if I make it too long",target:"015N010"},removed:false,selectable:true,selected:false,pannable:true,classes:"Implies",group:"edges"}, {locked:false,position:{x:0,y:0},grabbable:true,data:{id:"ae902d75-48cf-4e30-acb5-ca411fb7d4bc",target:"020N010",source:"024N010"},removed:false,selectable:true,selected:false,pannable:true,classes:"Implies",group:"edges"}, {locked:false,position:{x:0,y:0},grabbable:true,data:{id:"cd11979f-2a8c-44d5-a412-29f2257ed9f6",target:"023N010",source:"024N010"},removed:false,selectable:true,selected:false,pannable:true,classes:"Implies",group:"edges"}, {locked:false,position:{x:0,y:0},grabbable:true,data:{id:"45a01d3f-30a3-4aa9-8ae1-a65aec71fa50",target:"023N010",source:"022N010"},removed:false,selectable:true,selected:false,pannable:true,classes:"Implies",group:"edges"}, {locked:false,position:{x:0,y:0},grabbable:true,data:{id:"c84b1ac6-9eb0-42af-bf58-6a8db2747b96",target:"010N010",source:"022N010"},removed:false,selectable:true,selected:false,pannable:true,classes:"Implies",group:"edges"}, {locked:false,position:{x:0,y:0},grabbable:true,data:{id:"6f38ed1e-eaac-46c5-a5b4-388484f42cbf",target:"010N010",source:"023N010"},removed:false,selectable:true,selected:false,pannable:true,classes:"Implies",group:"edges"}, {locked:false,position:{x:0,y:0},grabbable:true,data:{target:"023N010",id:"d2fd8637-7895-44a1-b30b-8486d6942f57",source:"012N010"},removed:false,selectable:true,selected:false,pannable:true,classes:"Money",group:"edges"}, {locked:false,position:{x:0,y:0},grabbable:true,data:{target:"012N010",id:"9da662d6-0f20-428d-90fd-f540a171ce69",source:"023N010"},removed:false,selectable:true,selected:false,pannable:true,classes:"Debt",group:"edges"}]
        }
      };
      
      const cy = cytoscape({
        container: document.getElementById("cy"),
        elements: graphData.elements,
        style: [
           {
            selector: "node",
            style: {
                'background-color': 'transparent',
                'background-opacity': 0,
                'width': 'mapData(confidence, 0, 1, 10, 50)',
                'height': 'mapData(confidence, 0, 1, 10, 50)',
                label: "data(label)" ,
                color: "white"
            }
        },
        {
            selector: ".N010",
            style: {
                //'background-color': '#FFCCE3'
               'background-image': 'url(images/alt_node1.webp)',
                'background-color': 'transparent',
                'background-opacity': 1,
                'background-fit': 'cover'
            }
        },
        {
            selector: ".N020",
            style: {
                 // 'background-color': '#E7D5B7'
                'background-image': 'url(images/green_node2.png)',
                'background-color': 'transparent',
                'background-opacity': 1,
                'background-fit': 'cover'
            }
        },
        {
            selector: 'edge',
            style: {
                'width': 3,
                'control-point-distance': 50,
                'control-point-weight': 1,
                'line-color': '#ccc',
                "target-arrow-color": "#FF4136",
                "target-arrow-shape": "vee",
                "curve-style": "bezier",
                "arrow-scale": 2.5
            }
        },
        {
            selector: ".Implies",
            style: {
                'line-color': '#D1C2BC',
                "target-arrow-color": "#D1C2BC",
                'target-arrow-shape': 'vee',
                'control-point-distance': 80,
                'control-point-weight': 1,
                "curve-style": "bezier"
            }},
            {selector: ".Supports",
            style: {
                'line-color': '#00608A',
                "target-arrow-color": "#00608A",
                'target-arrow-shape': 'vee',
                'control-point-distance': 50,
                'control-point-weight': .3,
                "curve-style": "bezier"
            }
            
        },
         {selector: ".Contradicts",
            style: {
                'line-color': '#F47826',
                "target-arrow-color": "#F47826",
                'target-arrow-shape': 'vee',
                'control-point-distance': 80,
                'control-point-weight': 1,
                "curve-style": "bezier"
            }
            
        },
         {selector: ".Undermines",
            style: {
                'line-color': '#D29F17',
                "target-arrow-color": "#D29F17",
                'target-arrow-shape': 'vee',
                'control-point-distance': 50,
                'control-point-weight': 0.3,
                "curve-style": "bezier"
            }
            
        },
        {selector: ".Money",
            style: {
                'line-color': '#005F00',
                "target-arrow-color": "#005F00",
                'target-arrow-shape': 'vee',
                'control-point-distance': 100,
                'control-point-weight': 1.5,
                "curve-style": "bezier"
            }
            
        },
         {selector: ".Debt",
            style: {
                'line-color': '#AD0018',
                "target-arrow-color": "#AD0018",
                'target-arrow-shape': 'vee',
                'control-point-distance': 100,
                'control-point-weight': 1.5,
                "curve-style": "bezier"
            }
            
        }
    
        ],
        layout: { name: "preset" }
      });

let showNodeLabels = true; // Track the current state of the labels

document.getElementById("toggleLabels").addEventListener("click", () => {
    cy.batch(() => {
        if (showNodeLabels) {
            // Hide node labels and show edge labels
            cy.style()
                .selector('node')
                .style({
                    label: '' // Remove node labels
                })
                .selector('edge')
                .style({
                    label: 'data(description)', // Show edge descriptions as labels
                    //'text-rotation': 'autorotate',  Rotate edge labels with the edge direction
                    'text-margin-y': -10, // Optional: Adjust the position of the edge label
                    color: '#fff', // Set edge label color
                    'font-size': 10
                })
                .update();
        } else {
            // Show node labels and hide edge labels
            cy.style()
                .selector('node')
                .style({
                    label: 'data(label)' // Restore node labels
                })
                .selector('edge')
                .style({
                    label: '' // Remove edge labels
                })
                .update();
        }

        // Toggle the label state
        showNodeLabels = !showNodeLabels;
    });
});

      let selectedNodes = [];
      cy.on("tap", "node", (evt) => {
        const node = evt.target;
        if (!selectedNodes.includes(node.id())) {
          selectedNodes.push(node.id());
        }
        if (selectedNodes.length > 2) {
          selectedNodes.shift();
        }
      }); 
cy.on('select', 'edge', function(event) {
        const edge = event.target;
        const description = edge.data('description');
        document.getElementById('info-panel').innerHTML = description;
      });
      cy.on('tap', 'edge', function(event) {
        const edge = event.target;
        const currentDescription = edge.data('description') || '';
        const newDescription = prompt('Enter a description for this edge:', currentDescription);
        if (newDescription !== null) {
        edge.data('description', newDescription);
        edge.data('id', newDescription);
    }
      });

      document.getElementById("addEdge").addEventListener("click", () => {
        if (selectedNodes.length === 2) {
          const edgeClass = document.getElementById("edgeClass").value;
          cy.add({
            group: "edges",
            data: {
              source: selectedNodes[0],
              target: selectedNodes[1]
            },
          classes: edgeClass
          });
          selectedNodes = [];
        } else {
          alert("Select two nodes to add an edge.");
        }
      });

      document.getElementById("deleteEdge").addEventListener("click", () => {
        const selectedEdge = cy.edges(":selected");
        if (selectedEdge.length) {
          selectedEdge.remove();
        } else {
          alert("Select an edge to delete.");
        }
      });
     const slider = document.getElementById("confidenceSlider");
const confidenceValue = document.getElementById("confidenceValue");
const select = document.getElementById("nodeClass");

function filterNodes() {
    const threshold = parseFloat(slider.value); // Get the confidence threshold
    const selectedValues = Array.from(select.selectedOptions).map(option => option.value); // Get selected classes

    confidenceValue.textContent = threshold.toFixed(2);

    cy.batch(() => {
        // Filter nodes based on both confidence and class criteria
        cy.nodes().forEach((node) => {
            const confidence = node.data("confidence");
            const meetsConfidence = confidence >= threshold;
            const meetsClass = selectedValues.some(cls => node.hasClass(cls));

            if (meetsConfidence && meetsClass) {
                node.show();
            } else {
                node.hide();
            }
        });

        // Show edges only if both source and target nodes are visible
        cy.edges().forEach((edge) => {
            const sourceVisible = edge.source().visible();
            const targetVisible = edge.target().visible();
            if (sourceVisible && targetVisible) {
                edge.show();
            } else {
                edge.hide();
            }
        });
    });
}

// Event listeners for the slider and multi-select menu
slider.addEventListener("input", filterNodes);
select.addEventListener("change", filterNodes);

// Initial call to apply the filter
filterNodes();
      
      document.getElementById("save").addEventListener("click", () => {
  const updatedData = {
    elements: cy.json().elements
  };
  const jsonText = JSON.stringify(updatedData, null, 2);

  // Generate a timestamp
  const timestamp = new Date().toISOString().replace(/[:-]/g, '').replace('T', '_').split('.')[0];
  const filename = `data_${timestamp}.json`;

  // Create a downloadable link
  const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(jsonText);
  const dlAnchorElem = document.createElement("a");
  dlAnchorElem.setAttribute("href", dataStr);
  dlAnchorElem.setAttribute("download", filename); // Use the timestamped filename
  dlAnchorElem.click();
});
    });
  </script>
</body>
</html>